<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Domin√≥ da Tabuada</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #FF6B35; --secondary: #F7931E; --accent: #00D9FF;
            --dark: #1A1A2E; --light: #F5F5F5; --success: #00FF88;
            --error: #FF3366; --purple: #9D4EDD;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: linear-gradient(135deg, var(--dark) 0%, #16213E 100%);
            color: var(--light); min-height: 100vh;
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { text-align: center; padding: 20px 0; }

        h1 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: clamp(2rem, 8vw, 4rem); letter-spacing: 3px;
            background: linear-gradient(135deg, var(--primary), var(--secondary), var(--accent));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .subtitle { font-size: clamp(0.9rem, 3vw, 1.1rem); opacity: 0.8; letter-spacing: 2px; }

        .screen {
            background: rgba(255, 255, 255, 0.05); backdrop-blur: blur(10px);
            border-radius: 20px; padding: 30px; max-width: 600px;
            margin: 30px auto; border: 2px solid rgba(255, 255, 255, 0.1);
            display: none;
        }
        .screen.active { display: block; }
        .screen h2 {
            font-family: 'Bebas Neue', sans-serif; font-size: 2rem;
            color: var(--accent); margin-bottom: 30px; text-align: center;
        }

        .input-group { margin-bottom: 25px; }
        label {
            display: block; margin-bottom: 10px; font-weight: 500;
            color: var(--accent); font-size: 0.95rem;
        }

        input, select {
            width: 100%; padding: 15px; border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1); color: var(--light);
            font-size: 1rem; font-family: 'DM Sans', sans-serif;
        }
        input:focus, select:focus {
            outline: none; border-color: var(--accent);
            background: rgba(255, 255, 255, 0.15);
        }

        .btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white; border: none; padding: 18px 40px;
            border-radius: 50px; font-size: 1.2rem; font-weight: 700;
            cursor: pointer; width: 100%; margin-top: 20px;
            font-family: 'Bebas Neue', sans-serif; letter-spacing: 2px;
            transition: all 0.3s;
        }
        .btn:hover { transform: translateY(-3px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            margin-top: 10px;
        }

        .share-box {
            background: rgba(0, 217, 255, 0.1); border: 2px solid var(--accent);
            border-radius: 15px; padding: 25px; margin: 25px 0; text-align: center;
        }
        .share-box h3 {
            font-family: 'Bebas Neue', sans-serif; font-size: 1.5rem;
            color: var(--accent); margin-bottom: 15px;
        }
        .room-code {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 4rem; color: var(--success);
            letter-spacing: 10px; margin: 20px 0;
        }

        .players-list { margin: 20px 0; }
        .player-slot {
            background: rgba(255, 255, 255, 0.1); border-radius: 10px;
            padding: 15px 20px; margin-bottom: 10px; display: flex;
            align-items: center; gap: 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        .player-slot.filled {
            background: rgba(0, 255, 136, 0.1); border-color: var(--success);
        }
        .player-number {
            font-family: 'Bebas Neue', sans-serif; font-size: 1.5rem;
            color: var(--accent); min-width: 30px;
        }
        .player-info { flex: 1; }
        .player-name { font-weight: 700; font-size: 1.1rem; }
        .player-status { font-size: 0.9rem; opacity: 0.7; }

        /* GAME STYLES */
        .game-screen { max-width: 1200px; }
        .scoreboard {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px; margin-bottom: 20px;
        }
        .player-score {
            background: rgba(255, 255, 255, 0.05); border-radius: 15px;
            padding: 15px; border: 3px solid transparent; transition: all 0.3s;
        }
        .player-score.active {
            border-color: var(--accent);
            box-shadow: 0 0 30px rgba(0, 217, 255, 0.5);
        }
        .score-name {
            font-family: 'Bebas Neue', sans-serif; font-size: 1.3rem;
            color: var(--secondary); margin-bottom: 5px;
        }
        .score-value {
            font-size: 2rem; font-weight: 700; color: var(--accent);
        }
        .combo {
            font-size: 0.85rem; color: var(--success); margin-top: 5px;
        }

        .game-info {
            text-align: center; margin: 15px 0; font-size: 1.1rem; opacity: 0.8;
        }
        .current-turn {
            color: var(--accent); font-weight: 700; font-size: 1.3rem;
        }

        .board-area {
            background: rgba(255, 255, 255, 0.03); border-radius: 20px;
            padding: 20px; margin-bottom: 20px; min-height: 180px;
            border: 2px dashed rgba(255, 255, 255, 0.2);
            overflow-x: auto;
        }
        .board-line {
            display: flex; align-items: center; gap: 3px;
            min-width: min-content; padding: 10px;
        }
        .board-empty {
            text-align: center; opacity: 0.5; padding: 60px 20px;
        }

        .domino {
            background: linear-gradient(135deg, #ffffff, #e0e0e0);
            border-radius: 12px; height: 54px; display: inline-flex;
            cursor: pointer; transition: all 0.3s;
            border: 4px solid #333; box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
            flex-shrink: 0;
        }
        .domino:hover {
            transform: translateY(-10px);
            box-shadow: 0 10px 30px rgba(255, 107, 53, 0.7);
        }
        .domino.board-piece {
            cursor: default; animation: slideIn 0.4s ease-out;
        }
        .domino.board-piece:hover {
            transform: none; box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }
        @keyframes slideIn {
            from { transform: scale(0) rotate(180deg); opacity: 0; }
            to { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        .domino-half {
            width: 39px; display: flex; align-items: center;
            justify-content: center; font-size: 1.5rem; font-weight: 700;
            color: #1A1A2E; font-family: 'Bebas Neue', sans-serif;
        }
        .domino-divider { width: 4px; background: #333; height: 100%; }

        .player-hand {
            background: rgba(255, 255, 255, 0.05); border-radius: 15px;
            padding: 20px; margin-bottom: 20px;
        }
        .hand-title {
            font-family: 'Bebas Neue', sans-serif; font-size: 1.3rem;
            color: var(--accent); margin-bottom: 15px;
        }
        .hand-pieces {
            display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;
        }
        .not-your-turn {
            text-align: center; padding: 40px 20px; font-size: 1.2rem; opacity: 0.7;
        }
        .waiting-player {
            font-family: 'Bebas Neue', sans-serif; font-size: 2rem;
            color: var(--accent); margin-top: 10px;
        }

        .quiz-section {
            background: linear-gradient(135deg, var(--purple), var(--primary));
            border-radius: 20px; padding: 25px; margin: 20px 0;
            display: none; animation: popIn 0.5s ease-out;
        }
        .quiz-section.active { display: block; }
        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .quiz-question {
            font-size: 1.5rem; font-weight: 700; text-align: center;
            margin-bottom: 25px; font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 2px;
        }
        .quiz-options {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
        }
        .quiz-option {
            background: rgba(255, 255, 255, 0.2); border: 3px solid transparent;
            border-radius: 12px; padding: 20px; font-size: 1.8rem;
            font-weight: 700; cursor: pointer; transition: all 0.3s;
            text-align: center; font-family: 'Bebas Neue', sans-serif;
        }
        .quiz-option:hover {
            background: rgba(255, 255, 255, 0.3); transform: scale(1.1);
            border-color: white;
        }
        .quiz-option.correct {
            background: var(--success); border-color: var(--success);
            animation: correctAnim 0.6s ease-out;
        }
        .quiz-option.wrong {
            background: var(--error); border-color: var(--error);
            animation: shake 0.5s;
        }
        @keyframes correctAnim {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2) rotate(5deg); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .action-buttons {
            display: flex; gap: 12px; justify-content: center;
            margin-top: 15px; flex-wrap: wrap;
        }
        .action-btn {
            background: rgba(255, 255, 255, 0.1); border: 2px solid var(--accent);
            color: var(--accent); padding: 12px 25px; border-radius: 25px;
            font-weight: 700; cursor: pointer; transition: all 0.3s;
            font-size: 0.95rem;
        }
        .action-btn:hover {
            background: var(--accent); color: var(--dark); transform: translateY(-3px);
        }

        .timer-warning {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(255, 51, 102, 0.95); padding: 30px 50px;
            border-radius: 20px; font-size: 3rem; font-weight: 700;
            z-index: 1500; animation: pulse 1s infinite;
            font-family: 'Bebas Neue', sans-serif;
            display: none;
        }
        .timer-warning.show { display: block; }
        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }

        .winner-screen {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95);
            z-index: 2000; align-items: center; justify-content: center;
        }
        .winner-screen.show { display: flex; animation: fadeIn 0.5s; }
        @keyframes fadeIn {
            from { opacity: 0; } to { opacity: 1; }
        }
        .winner-content {
            text-align: center; animation: bounceIn 1s; padding: 20px;
        }
        @keyframes bounceIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .winner-content h2 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: clamp(3rem, 10vw, 6rem);
            background: linear-gradient(135deg, var(--success), var(--accent));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 20px; letter-spacing: 5px;
        }
        .winner-content p {
            font-size: clamp(1.2rem, 4vw, 2rem); margin-bottom: 30px;
        }

        .message {
            position: fixed; top: 20px; right: 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            padding: 20px 30px; border-radius: 10px; font-weight: 700;
            z-index: 1000; transform: translateX(400px); transition: transform 0.3s;
        }
        .message.show { transform: translateX(0); }

        @media (max-width: 768px) {
            .domino { height: 42px; }
            .domino-half { width: 30px; font-size: 1.2rem; }
            .quiz-option { font-size: 1.5rem; padding: 18px; }
            .room-code { font-size: 3rem; letter-spacing: 5px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>X-DOM√çNIOüîê</h1>
            <p class="subtitle">ü™∂Mathyra Versus</p>
        </header>

        <!-- Menu -->
        <div class="screen active" id="menuScreen">
            <h2>Bem-vindo!</h2>
            <button class="btn" onclick="showHostScreen()">CRIAR SALA</button>
            <button class="btn" onclick="showJoinScreen()">ENTRAR EM SALA</button>
        </div>

        <!-- Host Screen -->
        <div class="screen" id="hostScreen">
            <h2>Criar Sala</h2>
            <div class="input-group">
                <label>Quantos jogadores?</label>
                <select id="numPlayers">
                    <option value="2">2 Jogadores</option>
                    <option value="3">3 Jogadores</option>
                    <option value="4">4 Jogadores</option>
                </select>
            </div>
            <div class="input-group">
                <label>Seu Nome</label>
                <input type="text" id="hostName" placeholder="Digite seu nome" maxlength="15">
            </div>
            <button class="btn" onclick="createRoom()">CRIAR</button>
            <button class="btn btn-secondary" onclick="showScreen('menuScreen')">VOLTAR</button>
        </div>

        <!-- Join Screen -->
        <div class="screen" id="joinScreen">
            <h2>Entrar em Sala</h2>
            <div class="input-group">
                <label>C√≥digo da Sala</label>
                <input type="text" id="roomCodeInput" placeholder="Digite o c√≥digo" maxlength="10" style="text-transform: uppercase;">
            </div>
            <div class="input-group">
                <label>Seu Nome</label>
                <input type="text" id="playerName" placeholder="Digite seu nome" maxlength="15">
            </div>
            <button class="btn" onclick="joinRoom()">ENTRAR</button>
            <button class="btn btn-secondary" onclick="showScreen('menuScreen')">VOLTAR</button>
        </div>

        <!-- Lobby Screen -->
        <div class="screen" id="lobbyScreen">
            <h2>Sala de Espera</h2>
            <div class="share-box">
                <h3>C√≥digo da Sala</h3>
                <div class="room-code" id="displayRoomCode">-----</div>
                <p style="font-size: 0.9rem; opacity: 0.7;">Compartilhe este c√≥digo com seus amigos</p>
            </div>
            <div class="players-list" id="playersList"></div>
            <p style="text-align: center; opacity: 0.7; margin: 20px 0; font-size: 0.9rem;">
                üí° Quando todos entrarem, o jogo iniciar√° automaticamente
            </p>
        </div>

        <!-- Game Screen -->
        <div class="screen game-screen" id="gameScreen">
            <div class="scoreboard" id="scoreboard"></div>
            <div class="game-info">
                <p>Vez de: <span class="current-turn" id="currentTurn"></span></p>
            </div>

            <div class="board-area" id="boardArea">
                <div class="board-empty">A mesa est√° vazia. Jogue a primeira pe√ßa!</div>
            </div>
            <div class="quiz-section" id="quizSection">
                <div class="quiz-question" id="quizQuestion"></div>
                <div class="quiz-options" id="quizOptions"></div>
            </div>
            <div class="player-hand" id="playerHand">
                <div class="hand-title" id="handTitle"></div>
                <div id="handContent"></div>
            </div>
            <div class="action-buttons">
                <button class="action-btn" onclick="passTurn()">Passar Vez</button>
                <button class="action-btn" onclick="drawPiece()">Comprar Pe√ßa</button>
            </div>
        </div>

        <!-- Winner Screen -->
        <div class="winner-screen" id="winnerScreen">
            <div class="winner-content">
                <h2>VIT√ìRIA!</h2>
                <p id="winnerText"></p>
                <button class="btn" onclick="location.reload()">Jogar Novamente</button>
            </div>
        </div>

        <div class="timer-warning" id="timerWarning">‚è±Ô∏è 3</div>
        <div class="message" id="toast"></div>
    </div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDutK32Yay596BVSJiZ6qx1xVNsxhaT2YA",
            authDomain: "games-da-matematica.firebaseapp.com",
            projectId: "games-da-matematica",
            storageBucket: "games-da-matematica.firebasestorage.app",
            messagingSenderId: "426876710208",
            appId: "1:426876710208:web:9c38b6038e940c60b15ea5"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let isHost = false;
        let roomCode = '';
        let myPlayerId = '';
        let unsubscribe = null;
        let turnTimer = null;
        let turnStartTime = null;

        let gameState = {
            totalPlayers: 2,
            players: [],
            currentPlayerIndex: 0,
            board: [],
            stockPile: [],
            awaitingQuiz: false,
            gameStarted: false,
            turnStartTimestamp: null
        };

        function generateId() {
            return Math.random().toString(36).substring(2, 9).toUpperCase();
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function showHostScreen() {
            showScreen('hostScreen');
        }

        function showJoinScreen() {
            showScreen('joinScreen');
        }

        function startTurnTimer() {
            stopTurnTimer();
            
            const myIndex = getMyPlayerIndex();
            if (gameState.currentPlayerIndex !== myIndex || gameState.awaitingQuiz) {
                return;
            }

            turnStartTime = Date.now();
            
            turnTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - turnStartTime) / 1000);
                const remaining = 10 - elapsed;
                
                if (remaining <= 3 && remaining > 0) {
                    const warning = document.getElementById('timerWarning');
                    warning.textContent = `‚è±Ô∏è ${remaining}`;
                    warning.classList.add('show');
                } else {
                    document.getElementById('timerWarning').classList.remove('show');
                }
                
                if (remaining <= 0) {
                    stopTurnTimer();
                    showToast('‚è∞ Tempo esgotado!');
                    passTurn();
                }
            }, 100);
        }

        function stopTurnTimer() {
            if (turnTimer) {
                clearInterval(turnTimer);
                turnTimer = null;
            }
            document.getElementById('timerWarning').classList.remove('show');
        }

        async function createRoom() {
            const hostName = document.getElementById('hostName').value.trim();
            const numPlayers = parseInt(document.getElementById('numPlayers').value);

            if (!hostName) {
                showToast('‚ùå Digite seu nome!');
                return;
            }

            isHost = true;
            roomCode = generateId().substring(0, 6);
            myPlayerId = generateId();

            gameState.totalPlayers = numPlayers;
            gameState.players = [{
                id: myPlayerId,
                name: hostName,
                hand: [],
                score: 0,
                combo: 0
            }];

            try {
                await db.collection('games').doc(roomCode).set(gameState);
                
                document.getElementById('displayRoomCode').textContent = roomCode;
                showScreen('lobbyScreen');
                updateLobby();
                subscribeToGame();
                showToast('‚úÖ Sala criada!');
            } catch (err) {
                console.error('Error:', err);
                showToast('‚ùå Erro ao criar sala');
            }
        }

        async function joinRoom() {
            const code = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            const playerName = document.getElementById('playerName').value.trim();

            if (!code) {
                showToast('‚ùå Digite o c√≥digo!');
                return;
            }
            if (!playerName) {
                showToast('‚ùå Digite seu nome!');
                return;
            }

            try {
                const doc = await db.collection('games').doc(code).get();
                
                if (!doc.exists) {
                    showToast('‚ùå Sala n√£o encontrada!');
                    return;
                }

                const data = doc.data();
                
                if (data.gameStarted) {
                    showToast('‚ùå Jogo j√° come√ßou!');
                    return;
                }

                if (data.players.length >= data.totalPlayers) {
                    showToast('‚ùå Sala cheia!');
                    return;
                }

                roomCode = code;
                myPlayerId = generateId();

                data.players.push({
                    id: myPlayerId,
                    name: playerName,
                    hand: [],
                    score: 0,
                    combo: 0
                });

                await db.collection('games').doc(code).update(data);

                document.getElementById('displayRoomCode').textContent = code;
                showScreen('lobbyScreen');
                subscribeToGame();
                showToast('‚úÖ Entrou na sala!');
            } catch (err) {
                console.error('Error:', err);
                showToast('‚ùå Erro ao entrar');
            }
        }

        function subscribeToGame() {
            unsubscribe = db.collection('games').doc(roomCode).onSnapshot((doc) => {
                if (!doc.exists) return;

                const newState = doc.data();
                const previousPlayerIndex = gameState.currentPlayerIndex;
                gameState = newState;

                if (gameState.gameEnded && gameState.winner) {
                document.getElementById('winnerText').textContent = 
               `${gameState.winner.name} venceu com ${gameState.winner.score} pontos! üéâ`;
                document.getElementById('winnerScreen').classList.add('show');
                return;
       }

                if (!gameState.gameStarted) {
                    updateLobby();
                    
                    if (gameState.players.length === gameState.totalPlayers && isHost) {
                        setTimeout(() => startGame(), 2000);
                    }
                } else {
                    if (document.getElementById('lobbyScreen').classList.contains('active')) {
                        showScreen('gameScreen');
                    }
                    updateUI();
                    
                    if (previousPlayerIndex !== gameState.currentPlayerIndex) {
                        startTurnTimer();
                    }
                }
            });
        }

        async function startGame() {
            if (!isHost) return;

            showToast('üéÆ Iniciando jogo...');

            const stockPile = [];
for (let i = 0; i <= 9; i++) {
    for (let j = i; j <= 9; j++) {
        // Para pe√ßas com 0, criar DUAS vers√µes (uma com 0 √† esquerda, outra √† direita)
        if (i === 0 || j === 0) {
            stockPile.push({ left: i, right: j });
            if (i !== j) { // Evita duplicar 0-0
                stockPile.push({ left: j, right: i });
            }
        } else {
            // Para pe√ßas sem 0, continua aleat√≥rio
            if (Math.random() < 0.5) {
                stockPile.push({ left: i, right: j });
            } else {
                stockPile.push({ left: j, right: i });
            }
        }
    }
}
            stockPile.sort(() => Math.random() - 0.5);

            gameState.players.forEach(player => {
                player.hand = [];
                for (let i = 0; i < 7; i++) {
                    if (stockPile.length > 0) {
                        player.hand.push(stockPile.pop());
                    }
                }
            });

            gameState.board = [];
            gameState.stockPile = stockPile;
            gameState.currentPlayerIndex = 0;
            gameState.purchasesThisTurn = 0;
            gameState.awaitingQuiz = false;
            gameState.gameStarted = true;
            gameState.turnStartTimestamp = Date.now();

            await db.collection('games').doc(roomCode).update(gameState);
        }

        function updateLobby() {
            const playersList = document.getElementById('playersList');
            playersList.innerHTML = '';

            for (let i = 0; i < gameState.totalPlayers; i++) {
                const slot = document.createElement('div');
                if (i < gameState.players.length) {
                    slot.className = 'player-slot filled';
                    slot.innerHTML = `
                        <div class="player-number">${i + 1}</div>
                        <div class="player-info">
                            <div class="player-name">${gameState.players[i].name}</div>
                            <div class="player-status">‚úì Conectado</div>
                        </div>
                    `;
                } else {
                    slot.className = 'player-slot';
                    slot.innerHTML = `
                        <div class="player-number">${i + 1}</div>
                        <div class="player-info">
                            <div class="player-name">Aguardando...</div>
                            <div class="player-status">Compartilhe o c√≥digo</div>
                        </div>
                    `;
                }
                playersList.appendChild(slot);
            }
        }

        function getMyPlayerIndex() {
            return gameState.players.findIndex(p => p.id === myPlayerId);
        }

        function updateUI() {
            updateScoreboard();
            updateCurrentTurn();
            updateBoard();
            updatePlayerHand();
        }

        function updateScoreboard() {
            const scoreboard = document.getElementById('scoreboard');
            scoreboard.innerHTML = '';
            
            gameState.players.forEach((player, index) => {
                const scoreCard = document.createElement('div');
                scoreCard.className = `player-score ${index === gameState.currentPlayerIndex ? 'active' : ''}`;
                scoreCard.innerHTML = `
                    <div class="score-name">${player.name}</div>
                    <div class="score-value">${player.score} pts</div>
                    ${player.combo > 0 ? `<div class="combo">üî• Combo x${player.combo}</div>` : ''}
                `;
                scoreboard.appendChild(scoreCard);
            });
        }

        function updateCurrentTurn() {
            document.getElementById('currentTurn').textContent = gameState.players[gameState.currentPlayerIndex].name;
        }

        function updateBoard() {
            const boardArea = document.getElementById('boardArea');
            
            if (gameState.board.length === 0) {
                boardArea.innerHTML = '<div class="board-empty">A mesa est√° vazia. Jogue a primeira pe√ßa!</div>';
            } else if (gameState.board.length === 1) {
                const boardLine = document.createElement('div');
                boardLine.className = 'board-line';
                boardLine.appendChild(createDominoElement(gameState.board[0], null, true));
                boardArea.innerHTML = '';
                boardArea.appendChild(boardLine);
            } else if (gameState.board.length === 2) {
                const boardLine = document.createElement('div');
                boardLine.className = 'board-line';
                boardLine.appendChild(createDominoElement(gameState.board[0], null, true));
                boardLine.appendChild(createDominoElement(gameState.board[1], null, true));
                boardArea.innerHTML = '';
                boardArea.appendChild(boardLine);
            } else {
                const boardLine = document.createElement('div');
                boardLine.className = 'board-line';
                
                boardLine.appendChild(createDominoElement(gameState.board[0], null, true));
                boardLine.appendChild(createDominoElement(gameState.board[1], null, true));
                
                const dots = document.createElement('div');
                dots.style.cssText = 'font-size: 3rem; font-weight: bold; padding: 0 8px; opacity: 0.5;';
                dots.textContent = '...';
                boardLine.appendChild(dots);
                
                boardLine.appendChild(createDominoElement(gameState.board[gameState.board.length - 1], null, true));
                
                boardArea.innerHTML = '';
                boardArea.appendChild(boardLine);
            }
        }

        function updatePlayerHand() {
            const handContent = document.getElementById('handContent');
            const myIndex = getMyPlayerIndex();
            const currentPlayer = gameState.players[myIndex];
            
            document.getElementById('handTitle').textContent = `Sua M√£o (${currentPlayer.hand.length} pe√ßas)`;

            if (gameState.currentPlayerIndex !== myIndex || gameState.awaitingQuiz) {
                stopTurnTimer();
                handContent.innerHTML = `
                    <div class="not-your-turn">
                        <p>‚è≥ Aguardando...</p>
                        <div class="waiting-player">${gameState.players[gameState.currentPlayerIndex].name} est√° jogando</div>
                    </div>
                `;
                return;
            }

            const handPieces = document.createElement('div');
            handPieces.className = 'hand-pieces';
            currentPlayer.hand.forEach((piece, index) => {
                handPieces.appendChild(createDominoElement(piece, index, false));
            });
            handContent.innerHTML = '';
            handContent.appendChild(handPieces);
        }

        function createDominoElement(piece, index, isBoardPiece) {
            const domino = document.createElement('div');
            domino.className = 'domino' + (isBoardPiece ? ' board-piece' : '');
            if (index !== null && !isBoardPiece) {
                domino.onclick = () => selectPiece(index);
                domino.title = `Esquerda: ${piece.left} | Direita: ${piece.right}`;
            }
            domino.innerHTML = `
                <div class="domino-half">${piece.left}</div>
                <div class="domino-divider"></div>
                <div class="domino-half">${piece.right}</div>
            `;
            return domino;
        }

        function selectPiece(index) {
            if (gameState.awaitingQuiz) return;
            const myIndex = getMyPlayerIndex();
            if (gameState.currentPlayerIndex !== myIndex) return;

            const piece = gameState.players[myIndex].hand[index];
            
            if (gameState.board.length === 0) {
                playPiece(index);
            } else {
                const leftEnd = gameState.board[0].left;
                const rightEnd = gameState.board[gameState.board.length - 1].right;

                const canPlayLeft = piece.right === leftEnd;
                const canPlayRight = piece.left === rightEnd;

                if (canPlayLeft || canPlayRight) {
                    playPiece(index);
                } else {
                    showToast('‚ùå Pe√ßa n√£o encaixa! Compre ou passe a vez.');
                }
            }
        }

        function canPlayPiece(piece, leftEnd, rightEnd) {
            return piece.right === leftEnd || piece.left === rightEnd;
        }

        async function playPiece(index) {
            stopTurnTimer();
            const myIndex = getMyPlayerIndex();
            const piece = gameState.players[myIndex].hand[index];

            if (gameState.board.length === 0) {
                gameState.board.push({ left: piece.left, right: piece.right });
            } else {
                const leftEnd = gameState.board[0].left;
                const rightEnd = gameState.board[gameState.board.length - 1].right;
                
                if (piece.right === leftEnd) {
                    gameState.board.unshift({ left: piece.left, right: piece.right });
                } else if (piece.left === rightEnd) {
                    gameState.board.push({ left: piece.left, right: piece.right });
                } else {
                    showToast('‚ùå Pe√ßa Inv√°lida!');
                    return;
                }
            }

            gameState.players[myIndex].hand.splice(index, 1);
            await db.collection('games').doc(roomCode).update(gameState);
            
            updateBoard();
            showQuiz();
        }

        function showQuiz() {
            gameState.awaitingQuiz = true;

            const leftEnd = gameState.board[0].left;
            const rightEnd = gameState.board[gameState.board.length - 1].right;
            const product = leftEnd * rightEnd;

            document.getElementById('quizQuestion').textContent = 'Resultado da multiplica√ß√£o:';

            const options = new Set([product]);
            while (options.size < 4) {
                const offset = Math.floor(Math.random() * 20) - 10;
                const wrong = product + offset;
                if (wrong >= 0 && wrong <= 81 && wrong !== product) {
                    options.add(wrong);
                }
            }

            const optionsArray = Array.from(options).sort(() => Math.random() - 0.5);
            const quizOptions = document.getElementById('quizOptions');
            quizOptions.innerHTML = '';

            optionsArray.forEach(option => {
                const btn = document.createElement('div');
                btn.className = 'quiz-option';
                btn.textContent = option;
                btn.onclick = () => checkAnswer(option, product);
                quizOptions.appendChild(btn);
            });

            document.getElementById('quizSection').classList.add('active');
            updatePlayerHand();
document.getElementById('quizSection').classList.add('active');
// Timer invis√≠vel de 6 segundos
const quizTimeout = setTimeout(async () => {
    if (gameState.awaitingQuiz) {
        const myIndex = getMyPlayerIndex();
        gameState.players[myIndex].combo = 0;
        gameState.players[myIndex].score = Math.max(0, gameState.players[myIndex].score - 2);
        
        document.getElementById('quizSection').classList.remove('active');
        gameState.awaitingQuiz = false;
        showToast('‚è±Ô∏è Tempo esgotado! -2 pontos');
        await nextTurn();
    }
}, 6000);

updatePlayerHand();
        }

        async function checkAnswer(selected, correct) {
            const myIndex = getMyPlayerIndex();
            const currentPlayer = gameState.players[myIndex];
            const options = document.querySelectorAll('.quiz-option');

            options.forEach(opt => {
                opt.onclick = null;
                if (parseInt(opt.textContent) === selected) {
                    if (selected === correct) {
                        opt.classList.add('correct');
                        const leftEnd = gameState.board[0].left;
                        const rightEnd = gameState.board[gameState.board.length - 1].right;
                        const basePoints = Math.max(leftEnd, rightEnd);
                        currentPlayer.combo++;
                        const bonusMultiplier = Math.min(currentPlayer.combo, 3);
                        const points = basePoints * bonusMultiplier;
                        currentPlayer.score += points;
                        showToast(`‚úÖ +${points} pontos!`);

                        if (currentPlayer.score >= 200) {
                            setTimeout(() => showWinner(), 2000);
                            return;
                        }
                        if (currentPlayer.hand.length === 0) {
                            setTimeout(() => showWinner(), 2000);
                            return;
                        }
                    } else {
                        opt.classList.add('wrong');
                        currentPlayer.combo = 0;
                        currentPlayer.score = Math.max(0, currentPlayer.score - 2);
                        showToast('‚ùå Errou! -2 pontos');
                    }
                } else if (parseInt(opt.textContent) === correct) {
                    opt.classList.add('correct');
                }
            });

            setTimeout(async () => {
                document.getElementById('quizSection').classList.remove('active');
                gameState.awaitingQuiz = false;
                await nextTurn();
            }, 2000);
        }

        async function nextTurn() {
            gameState.currentPlayerIndex = (gameState.currentPlayerIndex + 1) % gameState.players.length;
            gameState.purchasesThisTurn = 0;            
            gameState.turnStartTimestamp = Date.now();
            await db.collection('games').doc(roomCode).update(gameState);
        }

        async function passTurn() {
            const myIndex = getMyPlayerIndex();
            if (gameState.awaitingQuiz) return;
            if (gameState.currentPlayerIndex !== myIndex) return;
            
            stopTurnTimer();
            showToast('‚è≠Ô∏è Passou a vez');
            await nextTurn();
        }

        async function drawPiece() {
            const myIndex = getMyPlayerIndex();
            if (gameState.awaitingQuiz) return;
            if (gameState.currentPlayerIndex !== myIndex) return;
          
            if (gameState.players[myIndex].hand.length >= 15) {
            showToast('‚ùå Limite de 15 pe√ßas na m√£o!');  // ADICIONAR
            return;
       }

            if (gameState.purchasesThisTurn >= 3) {
howToast('‚ùå J√° comprou 3 pe√ßas neste turno!');  // ADICIONAR
    return;
}
  
            if (gameState.stockPile.length === 0) {
                showToast('‚ùå Monte vazio!');
                return;
            }

            stopTurnTimer();
            const piece = gameState.stockPile.pop();
            gameState.players[myIndex].hand.push(piece);
            gameState.purchasesThisTurn++;
            await db.collection('games').doc(roomCode).update(gameState);
            showToast('üé¥ Comprou 1 pe√ßa');
            startTurnTimer();
        }

        async function showWinner() {
    stopTurnTimer();
    const winner = gameState.players.reduce((prev, current) => 
        (prev.score > current.score) ? prev : current
    );
    
    // Salvar vencedor no Firebase
    gameState.winner = {
        name: winner.name,
        score: winner.score
    };
    gameState.gameEnded = true;
    
    await db.collection('games').doc(roomCode).update(gameState);
    
    document.getElementById('winnerText').textContent = 
        `${winner.name} venceu com ${winner.score} pontos! üéâ`;
    document.getElementById('winnerScreen').classList.add('show');
}
    </script>
</body>
</html>